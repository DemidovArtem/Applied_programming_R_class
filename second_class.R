library(data.table)
library(lubridate)

myData = fread('transactions.csv')
str(myData)

myData[, TransDate:=dmy(TransDate)]

str(myData)

myData.december12 = myData[TransDate >= dmy('01.12.2012') & TransDate < dmy('01.01.2013')]

sales.december12 = sum(myData.december12[, PurchAmount])
print('The sales value is:')
print(sales.december12)

if (sales.december12 < 30000) {
  print('Run first campaign')
} else if (sales.december12 < 45000) {
  print('Run second campaign')
} else {
  print('Do nothing')
}

# Task 5
#================================================

sortedTransactions = myData[order(TransDate)]
sortedTransactions

cumSum = 0

for (index in 1:nrow(sortedTransactions)){
  cumSum = cumSum + sortedTransactions[index, PurchAmount]
  if (cumSum > 10^6){
    print('Achived index:')
    print(index)
    break
  }
}
print(cumSum)

# Task 6
#============================================

devisionFunction  = function(firstNumber, secondNumber) {
  firstNumber/secondNumber
}

devisionFunction(10, 5)

dicesFunction = function() {
  firstDiceValue = sample(1:6, 1)
  secondDiceValue = sample(1:6, 1)
  firstDiceValue + secondDiceValue
}

minValue = 13
maxValue = -1
for (i in 1:100){
  value = dicesFunction()
  if (value > maxValue){
    maxValue = value
  } else if (value < minValue){
    minValue = value
  }
}

print(minValue)
print(maxValue)



# Test
#=============================================


library(data.table)
PurchData <- data.table(Customer = c('C_125', 'C_106', 'C_123', 'C_122', 'C_107', 'C_102', 'C_106', 'C_104', 'C_110', 'C_120', 'C_114', 'C_113', 'C_101', 'C_124', 'C_120', 'C_113', 'C_116', 'C_101', 'C_104', 'C_106', 'C_124', 'C_111', 'C_120', 'C_117', 'C_110', 'C_101', 'C_115', 'C_125', 'C_104', 'C_109', 'C_111', 'C_104', 'C_105', 'C_114', 'C_116', 'C_116', 'C_119', 'C_103', 'C_106', 'C_101', 'C_117', 'C_115', 'C_115', 'C_125', 'C_116', 'C_108', 'C_119', 'C_106', 'C_102', 'C_109', 'C_123', 'C_125', 'C_115', 'C_116', 'C_109', 'C_117', 'C_125', 'C_123', 'C_108', 'C_101', 'C_100', 'C_122', 'C_109', 'C_119', 'C_107', 'C_121', 'C_109', 'C_104', 'C_109', 'C_103', 'C_104', 'C_117', 'C_107', 'C_112', 'C_109', 'C_121', 'C_116', 'C_108', 'C_119', 'C_122', 'C_110', 'C_118', 'C_109', 'C_109', 'C_110', 'C_109', 'C_119', 'C_103', 'C_114', 'C_104', 'C_104', 'C_115', 'C_125', 'C_118', 'C_113', 'C_103', 'C_118', 'C_116', 'C_104', 'C_102'), 
                        PurchAmount = c(382.65,280.75,355.35,379.3,394.6,327.6,270.65,289.85,129.35,325.85,249.8,215.15,292.1,340.3,351.85,209.25,349.4,286.5,372.75,199.55,150.7,186.75,189.75,109.2,107.6,348.85,120.25,100.55,275.6,181.7,108.75,253.25,263.4,222.8,386.1,360.65,315.6,126.85,273.35,283.3,308.8,218.8,232.5,245.55,178.95,114.9,314.5,175.1,239.4,112.95,118.25,366.35,326.1,392.85,241.85,138.15,352.2,194.2,335.5,319.45,369.15,134.2,390.75,265.3,281.75,345.65,234.1,104.45,116.1,122.35,391.8,137.85,258.4,157.3,290.35,211.2,353.5,311.8,131.15,115.45,147.35,230.65,106.3,346.45,300.6,322.55,393.6,359.35,123.5,272.15,342.6,140.1,298.6,141.4,125.85,223.8,246.5,303.2,227.7,279.35), 
                        Cost = c(35.8,50.15,21.55,82.45,80.85,47.3,45.25,88.25,73.45,53.65,23.85,85.75,29.8,60.2,37.15,52.25,23.15,87.65,75.95,90.2,30.15,63.8,22.9,49.7,74.15,34.7,46.75,69.2,53.5,38.85,74.9,33.8,90.95,74.6,82.85,43.4,76.25,24.45,87.45,44.2,26.25,64.8,48.9,88.6,27.75,39.2,71.15,61.15,90.65,46.2,81.9,39.85,41.1,75.6,60.3,24.35,73.55,85.5,21.2,26.8,29.2,34.65,35.9,71.2,26.5,57.7,35.85,42.8,73.7,49.85,42.25,62.25,20.3,79.6,64.7,20.3,64.7,70.6,64.2,78.7,62.3,28.5,74.5,46.7,24.7,90.85,87.2,64.6,50.35,25.8,81.15,78.1,51.85,33.45,65.5,84.2,22.25,59.55,27.5,62.65)
)

PurchData[, LeadCost:=shift(Cost, -1), by=Customer]

PurchData[Customer=="C_113"]

# Task 2
#===========================================
mySales <- data.table(Customer = c('C_109', 'C_105', 'C_114', 'C_112', 'C_115', 'C_107', 'C_109', 'C_112', 'C_118', 'C_121', 'C_105', 'C_103', 'C_112', 'C_108', 'C_119', 'C_102', 'C_103', 'C_116', 'C_120', 'C_112', 'C_112', 'C_115', 'C_105', 'C_103', 'C_108', 'C_116', 'C_111', 'C_123', 'C_111', 'C_107', 'C_120', 'C_108', 'C_116', 'C_119', 'C_115', 'C_102', 'C_112', 'C_111', 'C_119', 'C_114', 'C_106', 'C_121', 'C_105', 'C_123', 'C_100', 'C_120', 'C_122', 'C_101', 'C_100', 'C_114', 'C_120', 'C_104', 'C_107', 'C_101', 'C_121', 'C_112', 'C_105', 'C_109', 'C_110', 'C_109', 'C_115', 'C_119', 'C_117', 'C_123', 'C_104', 'C_109', 'C_124', 'C_111', 'C_114', 'C_121', 'C_118', 'C_107', 'C_117', 'C_123', 'C_117', 'C_105', 'C_109', 'C_112', 'C_110', 'C_123', 'C_125', 'C_120', 'C_120', 'C_101', 'C_114', 'C_107', 'C_125', 'C_108', 'C_115', 'C_104', 'C_110', 'C_107', 'C_106', 'C_119', 'C_114', 'C_102', 'C_121', 'C_115', 'C_115', 'C_120'), 
                      Revenue = c(228.35,293.15,238.8,310.5,340.35,136.35,117.55,356.55,368.7,157.75,321.2,371.7,200.9,265.6,114.25,335.95,300.6,254.7,375.25,127.6,101.6,306.55,219.7,169.1,242.65,379.5,203.2,298.45,381.95,338.9,161.5,376.4,120.55,190.9,351.3,324.4,192.55,263.9,284.75,275.8,201.8,119.25,337.2,236.65,355.25,230.4,246.1,273.1,396.3,283.6,106.85,125.35,388.5,364.65,393.25,191.5,189.35,341.25,333.65,290.6,208.85,281.75,326.8,206.25,328.15,182.5,115.5,234.9,264.3,162.2,224.25,129.8,336.8,103.75,256.15,377.2,391.3,330.6,317.6,352.2,322.7,145.85,257.35,135.9,116.8,197.3,380.9,363.1,158.7,397.45,155.65,249.7,126.35,109.85,104.65,172.4,279.3,240.3,297.2,296.85), 
                      Cost = c(77.6,80.75,49.95,44.4,24.55,69.1,60.9,48.6,26.45,31.6,71.4,21.6,84.15,49.65,50.75,34.7,42.6,28.45,27.4,84.45,47.25,88.2,34.25,87.75,64.35,43.4,80.2,21.15,65.65,89.3,44.4,56.35,83.1,52.9,75.2,50.6,31.75,56.25,52.6,32.4,81.2,73.3,83.25,59.2,42.95,35.35,28.4,88.15,50.95,71.7,29.9,28.75,64.45,32.7,90.6,73.9,63.8,39.75,57.55,74.85,78.2,71.8,28.65,50.45,31.8,55.6,89.45,71.65,85.75,45.6,80.45,63.65,53.5,23.65,87.2,30.4,50.45,51.3,65.15,43.45,85.65,85.3,53.35,61.6,86.8,51.15,66.85,28.6,20.6,81.5,61.3,54.75,36.6,80.65,63.85,25.55,60.5,20.75,72.95,88.3)
)


KPIs <- function(x){
  total_profit <- sum(x$Revenue) - sum(x$Cost)
  average_profit = mean(x$Revenue - x$Cost)
  result <- list(total_profit, average_profit)
  return(result)   
}

KPIs(mySales)


mySalesSubset = mySales[mySales[, Customer] %in% c('C_124', 'C_102', 'C_125', 'C_122', "C_114")]

KPIs(mySalesSubset)


# Task 3
#=======================================

customer <- data.table(Customer = c('C_1871','C_1518','C_4390','C_4848','C_2088','C_1508','C_2229','C_3170','C_3431','C_2836','C_4690','C_3562','C_4500','C_4979','C_4050','C_3824','C_1723','C_3786','C_2923','C_1414','C_4281','C_4876','C_3850','C_1734','C_1137','C_4638','C_2554','C_4655','C_4059','C_4938','C_2470','C_2120','C_3629','C_2256','C_3514','C_1512','C_3936','C_1450','C_4762','C_2347','C_3082','C_3709','C_3151','C_3972','C_2422','C_4305','C_1037','C_2253','C_2121','C_3058'), 
                       ChurnProb = c(0.81,0.96,0.68,0.65,0.28,0.29,0.37,0.71,0.48,0.09,0.42,0.65,0.17,0.28,0.87,0.21,0.18,0.32,0.18,0.98,0.92,0.9,0.77,0.03,0.31,0.53,0.76,0.73,0.88,0.48,0.01,0.1,0.41,0.99,0.27,0.29,0.48,0.39,0.75,0.13,0.92,0.06,0.72,0.9,0.49,0.54,0.44,0.27,0.9,0.23), 
                       Cost = c('21.04.2006','26.01.2007','15.07.2012','21.04.2006','15.03.2010','28.05.2008','30.11.2005','21.04.2006','30.11.2005','15.03.2010','15.07.2012','21.04.2006','28.05.2008','21.04.2006','21.04.2006','15.07.2012','15.03.2010','26.01.2007','30.11.2005','28.02.2006','15.03.2010','15.07.2012','15.07.2012','21.04.2006','15.03.2010','08.08.2012','30.11.2005','28.05.2008','08.08.2012','15.07.2012','15.07.2012','21.04.2006','12.08.2007','15.03.2010','26.01.2007','21.04.2006','15.07.2012','15.03.2010','28.02.2006','15.03.2010','28.05.2008','26.01.2007','12.08.2007','12.08.2007','21.04.2006','28.02.2006','15.07.2012','26.01.2007','28.05.2008','15.03.2010')
)

personal <- data.table(CustomerID = c('C_1871','C_1518','C_4390','C_4848','C_2088','C_1508','C_2229','C_3170','C_3431','C_2836','C_4690','C_3562','C_4500','C_4979','C_4050','C_3824','C_1723','C_3786','C_2923','C_1414','C_4281','C_4876','C_3850','C_1734','C_1137','C_4638','C_2554','C_4655','C_4059','C_4938','C_2470','C_2120','C_3629','C_2256','C_3514','C_1512','C_3936','C_1450','C_4762','C_2347','C_3082','C_3709','C_3151','C_3972','C_2422','C_4305','C_1037','C_2253','C_2121','C_3058','C_8340','C_7418','C_8184','C_7769','C_5755'), 
                       Gender = c('female','male','male','male','female','female','male','female','male','female','male','female','male','male','male','female','female','male','female','male','female','male','male','male','female','male','female','female','male','female','male','female','male','female','female','female','female','female','female','female','female','female','male','male','male','female','female','female','male','female','female','male','female','male','female'), 
                       Zip = c(4444,3333,1111,1111,3333,1111,4444,2222,1111,4444,4444,3333,1111,3333,3333,2222,3333,2222,2222,2222,2222,4444,4444,2222,2222,1111,3333,4444,3333,1111,3333,3333,4444,3333,1111,2222,1111,4444,3333,4444,2222,1111,2222,2222,1111,2222,2222,3333,2222,3333,1111,4444,3333,1111,3333)
)

transactions <- data.table(Customer = c('C_1734','C_3151','C_4281','C_4938','C_4500','C_2554','C_4848','C_1871','C_3514','C_2923','C_1512','C_3824','C_1450','C_2836','C_3850','C_4050','C_1518','C_3082','C_2088','C_3629','C_2256','C_3709','C_2120','C_2347','C_4305','C_3972','C_1508','C_1723','C_3170','C_1037','C_3786','C_2253','C_4979','C_4876','C_2229','C_3058','C_3562','C_1137','C_2470','C_2121'), 
                           NumberPurchases = c(38,14,23,46,31,16,10,4,47,36,49,33,12,9,25,4,38,23,40,24,23,25,25,39,16,37,35,37,11,42,12,29,4,18,23,1,39,13,8,26)
)


personal[, Customer:=CustomerID]
personal_customer = merge(customer, personal, by="Customer", nomatch=0)
length(merge(personal_customer, transactions, by="Customer", nomatch=0)$Customer)
